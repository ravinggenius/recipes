// Generated by CoffeeScript 1.3.1
var MAX_AGE_ONE_YEAR, app, derby, express, flickr, gzip, path, publicPath, root, server, staticPages, store;

path = require('path');

express = require('express');

derby = require('derby');

gzip = require('connect-gzip');

app = require('../app');

flickr = require('./flickr');

MAX_AGE_ONE_YEAR = {
  maxAge: 1000 * 60 * 60 * 24 * 365
};

root = path.dirname(path.dirname(__dirname));

publicPath = path.join(root, 'public');

staticPages = derby.createStatic(root);

(module.exports = server = express.createServer()).use(gzip.staticGzip(publicPath, MAX_AGE_ONE_YEAR)).use(express.favicon()).use(gzip.gzip()).use(app.router()).use(server.router);

server.configure('development', function() {
  return server.error(function(err, req, res, next) {
    if (err) {
      console.log(err.stack ? err.stack : err);
    }
    return next(err);
  });
});

server.error(function(err, req, res) {
  var message, status;
  message = err.message || err.toString();
  status = parseInt(message);
  if (status === 404) {
    return staticPages.render('404', res, {
      url: req.url
    }, 404);
  } else {
    return res.send((400 <= status && status < 600) ? status : 500);
  }
});

server.all('*', function(req) {
  throw "404: " + req.url;
});

store = app.createStore({
  listen: server
});

flickr.setup(store, {
  key: '86958e03c183fcb1b7fddfeb19f3a423'
});
