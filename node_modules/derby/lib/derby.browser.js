// Generated by CoffeeScript 1.3.1
var Dom, History, Page, View, addHttpMethods, autoRefresh, derbyModel, racer, util, _ref;

racer = require('racer');

derbyModel = require('./derby.Model');

Dom = require('./Dom');

View = require('./View');

History = require('./History');

autoRefresh = require('./refresh').autoRefresh;

_ref = require('./router'), addHttpMethods = _ref.addHttpMethods, Page = _ref.Page;

util = require('./util');

exports.createApp = function(appModule) {
  var appExports, routes, view;
  appExports = appModule.exports;
  appModule.exports = function(modelBundle, appHash, debug, ns, ctx) {
    if (debug) {
      util.DEBUG = true;
    }
    racer.on('init', function(model) {
      var dom, history, page;
      view.model = model;
      view.dom = dom = new Dom(model, appExports);
      derbyModel.init(model, dom, view);
      page = new Page(view, model);
      history = view.history = new History(page, routes, dom);
      try {
        return view.render(model, ns, ctx, true);
      } catch (err) {

      }
    });
    if (debug) {
      racer.on('ready', function(model) {
        return autoRefresh(view, model, appHash);
      });
    }
    racer.init(modelBundle);
    return appExports;
  };
  appModule.exports.view = appExports.view = view = new View;
  routes = addHttpMethods(appExports);
  appExports.ready = function(fn) {
    return racer.on('ready', fn);
  };
  return appExports;
};
